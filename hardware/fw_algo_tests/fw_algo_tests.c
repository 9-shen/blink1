

#include <stdio.h>

#include "led_fader.h"

const int NUM_LEDS = 4;

rgb_t leds[ NUM_LEDS ];

fader_t faders[ NUM_LEDS ];

void test_led_fader( int times );
void test_led_picker();


//
int main()
{
        
    printf("ledtst:\n");

    test_led_fader( 500 );

#if 0
    test_led_picker();
#endif
    
    return 0;
}

//-----------------------------------------------------

//
void dump_led_state()
{
    for( int i=0; i<NUM_LEDS; i++ ) {
        rgb_t* cur = &leds[i];
        fader_t* f = &faders[i];
        char doneflag = ((f->faderpos/256)==255) ? '*':' ';
        printf("%c%2d: %2.2x%2.2x%2.2x : %2.2x%2.2x%2.2x - %2.2x%2.2x%2.2x : %d %d\n",
               doneflag, i, cur->r,cur->g,cur->b,
               f->last.r,f->last.g,f->last.b,
               f->dest.r,f->dest.g,f->dest.b,
               f->blendfract, f->faderpos  );
    }
}
//
void test_led_fader( int times )
{

    rgb_set( leds[1], 0x00,0x00,0x00 );
    rgb_set( leds[2], 0xff,0x00,0x88 );
    rgb_set( leds[3], 0x11,0x22,0x33 );

    rgb_t newc;
    rgb_set( newc, 0xff,0xff,0xff );
    led_set_dest( &newc, 33, 1 );

    rgb_set( newc, 0x33,0x66,0xff );
    led_set_dest( &newc, 40, 2 );

    rgb_set( newc, 0x00,0x22,0x00 );
    led_set_dest( &newc, 10, 3 );

    printf("     cur   : last   -  dest  : blendfract,faderpos\n"); 
    dump_led_state();

    for( int i=0; i< times; i++ ) {
        led_update_faders();
        printf("--- %d \n",i);
        dump_led_state();
    }
    
}







//                  1         2         3         4         5         6
//        0123456789012345678901234567890123456789012345678901234567890123
//   00 - 1100000000000000000000000000000000000000000000000000000000000000
//   01 - 0011000000000000000000000000000000000000000000000000000000000000
//   02 - 0000110000000000000000000000000000000000000000000000000000000000
//   03 - 0000001100000000000000000000000000000000000000000000000000000000
//   04 - 0000000011000000000000000000000000000000000000000000000000000000
//   05 - 0000000000110000000000000000000000000000000000000000000000000000
//   06 - 0000000000001100000000000000000000000000000000000000000000000000
//   07 - 0000000000000011000000000000000000000000000000000000000000000000
//   08 - 0000000000000000110000000000000000000000000000000000000000000000
//   09 - 0000000000000000001100000000000000000000000000000000000000000000
//   0A - 0000000000000000000011000000000000000000000000000000000000000000
//   0B - 0000000000000000000000110000000000000000000000000000000000000000
//   0C - 0000000000000000000000001100000000000000000000000000000000000000
//   0D - 0000000000000000000000000011000000000000000000000000000000000000
//   0E - 0000000000000000000000000000110000000000000000000000000000000000
//   0F - 0000000000000000000000000000001100000000000000000000000000000000
//   10 - 0000000000000000000000000000000011000000000000000000000000000000
//   11 - 0000000000000000000000000000000000110000000000000000000000000000
//   12 - 0000000000000000000000000000000000001100000000000000000000000000
//   13 - 0000000000000000000000000000000000000011000000000000000000000000
//   14 - 0000000000000000000000000000000000000000110000000000000000000000
//   15 - 0000000000000000000000000000000000000000001100000000000000000000
//   16 - 0000000000000000000000000000000000000000000011000000000000000000
//   17 - 0000000000000000000000000000000000000000000000110000000000000000
//   18 - 0000000000000000000000000000000000000000000000001100000000000000
//   19 - 0000000000000000000000000000000000000000000000000011000000000000
//   1A - 0000000000000000000000000000000000000000000000000000110000000000
//   1B - 0000000000000000000000000000000000000000000000000000001100000000
//   1C - 0000000000000000000000000000000000000000000000000000000011000000
//   1D - 0000000000000000000000000000000000000000000000000000000000110000
//   1E - 0000000000000000000000000000000000000000000000000000000000001100
//   1F - 0000000000000000000000000000000000000000000000000000000000000011
//                  1         2         3         4         5         6
//        0123456789012345678901234567890123456789012345678901234567890123
//   20 - 1111000000000000000000000000000000000000000000000000000000000000
//   21 - 0000111100000000000000000000000000000000000000000000000000000000
//   22 - 0000000011110000000000000000000000000000000000000000000000000000
//   23 - 0000000000001111000000000000000000000000000000000000000000000000
//   24 - 0000000000000000111100000000000000000000000000000000000000000000
//   25 - 0000000000000000000011110000000000000000000000000000000000000000
//   26 - 0000000000000000000000001111000000000000000000000000000000000000
//   27 - 0000000000000000000000000000111100000000000000000000000000000000
//   28 - 0000000000000000000000000000000011110000000000000000000000000000
//   29 - 0000000000000000000000000000000000001111000000000000000000000000
//   2A - 0000000000000000000000000000000000000000111100000000000000000000
//   2B - 0000000000000000000000000000000000000000000011110000000000000000
//   2C - 0000000000000000000000000000000000000000000000001111000000000000
//   2D - 0000000000000000000000000000000000000000000000000000111100000000
//   2E - 0000000000000000000000000000000000000000000000000000000011110000
//   2F - 0000000000000000000000000000000000000000000000000000000000001111
//                  1         2         3         4         5         6
//        0123456789012345678901234567890123456789012345678901234567890123
//   30 - 1111111100000000000000000000000000000000000000000000000000000000
//   31 - 0000000011111111000000000000000000000000000000000000000000000000
//   32 - 0000000000000000111111110000000000000000000000000000000000000000
//   33 - 0000000000000000000000001111111100000000000000000000000000000000
//   34 - 0000000000000000000000000000000011111111000000000000000000000000
//   35 - 0000000000000000000000000000000000000000111111110000000000000000
//   36 - 0000000000000000000000000000000000000000000000001111111100000000
//   37 - 0000000000000000000000000000000000000000000000000000000011111111
//                  1         2         3         4         5         6
//        0123456789012345678901234567890123456789012345678901234567890123
//   38 - 1111111111111111000000000000000000000000000000000000000000000000
//   39 - 0000000000000000111111111111111100000000000000000000000000000000
//   3A - 0000000000000000000000000000000011111111111111110000000000000000
//   3B - 0000000000000000000000000000000000000000000000001111111111111111
//                  1         2         3         4         5         6
//        0123456789012345678901234567890123456789012345678901234567890123
//   3C - 0000000000000000000000000000000000000000000000000000000000000000
//   3D - 1111111111111111111111111111111100000000000000000000000000000000
//   3E - 0000000000000000000000000000000011111111111111111111111111111111
//   3F - 1111111111111111111111111111111111111111111111111111111111111111

int get_led_state(int m, int i, int st)
{
    
    if(      m < 0x20 ) {
        if( !st )  st = ((m-0x00)*2 == i) ? 2 : st;
        else st--;
    }
    else if( m < 0x30 ) {
        if( !st )  st = ((m-0x20)*4 == i) ? 4 : st;
        else st--;
    }
    else if( m < 0x38 ) {
        if( !st )  st = ((m-0x30)*8 == i) ? 8 : st;
        else st--;
    }
    else if( m < 0x3C ) {
        if( !st )  st = ((m-0x38)*16 == i) ? 16 : st;
        else st--;
    }
    else if( m < 0x3E ) {
        if( !st )  st = ((m-0x3C)*32 == i) ? 32 : st;
        else st--;
    }
    else {
        if( !st )  st = ((m-0x3F)*64 == i) ? 64 : st;
        else st--;
    }
    return st;
}

//
void test_led_picker()
{
    for( int m = 0; m<64; m++ ) {
        printf("%2.2x: ",m);
        int st = 0;
        for( int i=0; i< NUM_LEDS; i++) {
            st = get_led_state( m, i, st);
            //printf("%1x%s", (st)?st-1:st, ((((i+1)%4)==0)?" ":""));
            printf("%1x%s", st ? 1:0, ((((i+1)%4)==0)?" ":""));
        }

        printf("\n");
    }

#if 0
    int st = 0;
    for( int i=0; i< NUM_LEDS; i++) {
        int n = (i % m) == 0 ;
        if( n ) st = !st;
        //printf("%2d - %2d - %d\n", i, n, st);
        printf("%1d%s", st, ((((i+1)%4)==0)?" ":""));
    }
#endif

}
